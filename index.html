<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>ABLUKA – Turnuva Modu</title>
<style>
body{
  background:#111;
  color:#fff;
  font-family:Arial, sans-serif;
  display:flex;
  justify-content:center;
  margin-top:20px;
}
#game{text-align:center}
#board{
  display:grid;
  grid-template-columns:repeat(7,60px);
  gap:4px;
  margin:10px auto;
}
.cell{
  width:60px;height:60px;
  background:#444;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.white{background:#eee;border-radius:50%}
.black{background:#000;border-radius:50%}
.block{background:darkred}
.selected{outline:3px solid yellow}
</style>
</head>

<body>
<div id="game">
  <h2>ABLUKA – 3 Set</h2>
  <p id="status"></p>
  <div id="board"></div>
</div>

<script>
const SIZE=7;
const TOP_START=3;
const BOTTOM_START=45;
let set=1, playerScore=0, aiScore=0;
let playerColor, aiColor;
let board, playerPos, aiPos;
let phase="move", selected=null;

const status=document.getElementById("status");
const boardDiv=document.getElementById("board");

function kura(){
  playerColor = Math.random()<0.5 ? 1 : 2;
  aiColor = playerColor===1?2:1;
}

function setupSet(){
  board=Array(49).fill(0);
  if(playerColor===1){
    playerPos=BOTTOM_START;
    aiPos=TOP_START;
  }else{
    playerPos=TOP_START;
    aiPos=BOTTOM_START;
  }
  board[playerPos]=playerColor;
  board[aiPos]=aiColor;
  phase="move";
  selected=null;
  status.textContent=`Set ${set} | Sen: ${playerColor===1?"Beyaz":"Siyah"}`;
  draw();
}

function draw(){
  boardDiv.innerHTML="";
  board.forEach((v,i)=>{
    let d=document.createElement("div");
    d.className="cell";
    if(v===1)d.classList.add("white");
    if(v===2)d.classList.add("black");
    if(v===-1)d.classList.add("block");
    if(i===selected)d.classList.add("selected");
    d.onclick=()=>click(i);
    boardDiv.appendChild(d);
  });
}

function neighbors(i){
  let x=i%SIZE,y=Math.floor(i/SIZE),res=[];
  for(let dx=-1;dx<=1;dx++)
    for(let dy=-1;dy<=1;dy++){
      if(dx||dy){
        let nx=x+dx,ny=y+dy;
        if(nx>=0&&ny>=0&&nx<SIZE&&ny<SIZE)
          res.push(ny*SIZE+nx);
      }
    }
  return res;
}

function moves(pos,b){
  return neighbors(pos).filter(i=>b[i]===0);
}

function hasMove(pos,b){
  return moves(pos,b).length>0;
}

function evalBoard(b,pPos,aPos){
  let aiM=moves(aPos,b).length;
  let pM=moves(pPos,b).length;
  let trapBonus = pM===0 ? 100 : 0;
  return aiM*4 - pM*6 + trapBonus;
}

function minimax(b,pPos,aPos,depth,alpha,beta,max){
  if(depth===0 || !hasMove(pPos,b) || !hasMove(aPos,b))
    return evalBoard(b,pPos,aPos);

  if(max){
    let best=-999;
    for(let m of moves(aPos,b)){
      let nb=b.slice();
      nb[aPos]=0; nb[m]=aiColor;
      let val=minimax(nb,pPos,m,depth-1,alpha,beta,false);
      best=Math.max(best,val);
      alpha=Math.max(alpha,best);
      if(beta<=alpha)break;
    }
    return best;
  }else{
    let best=999;
    for(let m of moves(pPos,b)){
      let nb=b.slice();
      nb[pPos]=0; nb[m]=playerColor;
      let val=minimax(nb,m,aPos,depth-1,alpha,beta,true);
      best=Math.min(best,val);
      beta=Math.min(beta,best);
      if(beta<=alpha)break;
    }
    return best;
  }
}

function bestBlock(b,pPos,aPos){
  let best=null,bestScore=999;
  for(let i=0;i<b.length;i++){
    if(b[i]!==0)continue;
    let nb=b.slice();
    nb[i]=-1;
    let score=moves(pPos,nb).length + moves(aPos,nb).length;
    if(score<bestScore){
      bestScore=score;
      best=i;
    }
  }
  return best;
}

function click(i){
  if(phase!=="move")return;
  if(i===playerPos)selected=i;
  else if(selected!==null && neighbors(playerPos).includes(i) && board[i]===0){
    board[playerPos]=0;
    playerPos=i;
    board[playerPos]=playerColor;
    selected=null;
    phase="block";
    draw();
    setTimeout(playerBlock,100);
  }
}

function playerBlock(){
  phase="waitBlock";
}

boardDiv.addEventListener("click",e=>{
  if(phase==="waitBlock"){
    let i=[...boardDiv.children].indexOf(e.target);
    if(board[i]===0){
      board[i]=-1;
      phase="ai";
      draw();
      setTimeout(aiTurn,300);
    }
  }
});

function aiTurn(){
  if(!hasMove(aiPos,board)){
    endSet(true);return;
  }
  let best=-999,move=null;
  for(let m of moves(aiPos,board)){
    let nb=board.slice();
    nb[aiPos]=0; nb[m]=aiColor;
    let val=minimax(nb,playerPos,m,5,-999,999,false);
    if(val>best){best=val;move=m;}
  }
  board[aiPos]=0;
  aiPos=move;
  board[aiPos]=aiColor;

  let block=bestBlock(board,playerPos,aiPos);
  if(block!==null)board[block]=-1;

  if(!hasMove(playerPos,board)){
    endSet(false);return;
  }
  phase="move";
  draw();
}

function endSet(playerWin){
  if(playerWin)playerScore++; else aiScore++;
  set++;
  if(playerScore===2 || aiScore===2 || set>3){
    alert(`MAÇ BİTTİ\nSen: ${playerScore} – AI: ${aiScore}`);
    location.reload();
    return;
  }
  [playerColor,aiColor]=[aiColor,playerColor];
  setupSet();
}

kura();
setupSet();
</script>
</body>
</html>
